{
  "rules": {
    // ルートレベルでのデフォルトアクセス権限
    ".read": "auth != null",
    ".write": false, // 明示的に許可されていない限りは書き込み不可
    
    // ゲームセッション
    "game_sessions": {
      ".read": "auth != null", // 認証済みユーザーは閲覧可能
      ".write": false, // デフォルトでは書き込み不可
      
      // 新規セッション作成のみ許可
      ".validate": "newData.hasChild('creatorId') && newData.child('creatorId').val() === auth.uid",
      
      "$gameId": {
        ".read": "auth != null", // セッションの閲覧は認証済みユーザーに許可
        // 以下の条件のいずれかに当てはまる場合のみ書き込み許可:
        // 1. 新規作成かつ作成者IDが自分
        // 2. 既存セッションの作成者
        // 3. セッションの参加者
        ".write": "(!data.exists() && newData.child('creatorId').val() === auth.uid) || 
                   (data.exists() && data.child('creatorId').val() === auth.uid) || 
                   (data.exists() && data.child('players').hasChild(auth.uid))",
        
        "players": {
          ".read": "auth != null",
          // 参加者リスト全体に対する書き込みは作成者のみ
          ".write": "root.child('game_sessions').child($gameId).child('creatorId').val() === auth.uid",
          
          "$userId": {
            ".read": "auth != null",
            // 自分自身のデータまたはセッション作成者のみ書き込み可能
            ".write": "auth.uid === $userId || root.child('game_sessions').child($gameId).child('creatorId').val() === auth.uid"
          }
        },
        
        "creatorId": {
          ".validate": "newData.val() === auth.uid" // 作成者IDは自分のIDのみ設定可能
        }
      }
    },
    
    // カスタムルーム（より厳格なセキュリティ）
    "custom_rooms": {
      ".read": "auth != null", // 認証済みユーザーは閲覧可能
      ".write": false, // デフォルトでは書き込み不可
      
      "$roomId": {
        ".read": "auth != null",
        // 以下の条件のいずれかに当てはまる場合のみ書き込み許可:
        // 1. 新規作成かつ作成者IDが自分
        // 2. 既存ルームの作成者
        // 3. ルームの参加者（participants）
        ".write": "(!data.exists() && newData.child('creatorId').val() === auth.uid) || 
                   (data.exists() && data.child('creatorId').val() === auth.uid) || 
                   (data.exists() && data.child('participants').hasChild(auth.uid))",
        
        "participants": {
          ".read": "auth != null",
          // 参加者リスト全体への書き込みはルーム作成者のみ
          ".write": "root.child('custom_rooms').child($roomId).child('creatorId').val() === auth.uid",
          
          "$userId": {
            ".read": "auth != null",
            // 自分自身の参加状態または作成者のみ変更可能
            ".write": "auth.uid === $userId || root.child('custom_rooms').child($roomId).child('creatorId').val() === auth.uid"
          }
        },
        
        "creatorId": {
          ".validate": "newData.val() === auth.uid" // 作成者IDは自分のIDのみ設定可能
        }
      }
    },
    
    // マッチメイキング
    "matchmaking": {
      ".read": "auth != null",
      
      "$queueId": {
        ".read": "auth != null",
        ".write": "auth != null", // 認証済みユーザーは書き込み可能
        
        "$userId": {
          ".read": "auth != null",
          // 自分自身のエントリーのみ書き込み可能
          ".write": "auth.uid === $userId"
        }
      }
    },
    
    // オンラインユーザー
    "online_users": {
      ".read": "auth != null",
      ".write": false, // デフォルトでは書き込み不可
      
      "$userId": {
        ".read": "auth != null",
        // 自分自身のオンラインステータスのみ変更可能
        ".write": "auth.uid === $userId"
      }
    }
  }
}
