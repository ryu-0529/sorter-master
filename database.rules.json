{
  "rules": {
    // ルートレベル: デフォルトでアクセス拒否
    ".read": false,
    ".write": false,
    
    // ゲームセッション管理
    "game_sessions": {
      ".read": "auth != null",
      ".write": false, // デフォルトでは書き込み不可
      
      "$sessionId": {
        ".read": "auth != null",
        ".write": "auth != null && (
          // 新規セッション作成: 作成者IDが自分であることを確認
          (!data.exists() && newData.child('creatorId').val() === auth.uid) ||
          // 既存セッション: 作成者または参加者のみ
          (data.exists() && (
            data.child('creatorId').val() === auth.uid ||
            data.child('players').hasChild(auth.uid)
          ))
        )",
        
        // セッションメタデータ
        "creatorId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "status": {
          ".validate": "newData.isString() && newData.val().matches(/^(waiting|active|finished)$/)"
        },
        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 4"
        },
        "gameType": {
          ".validate": "newData.isString()"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        
        // プレイヤー管理
        "players": {
          ".read": "auth != null",
          
          "$playerId": {
            ".read": "auth != null",
            ".write": "auth != null && (
              // 自分自身のプレイヤーデータ、または
              auth.uid === $playerId ||
              // セッション作成者による管理
              root.child('game_sessions').child($sessionId).child('creatorId').val() === auth.uid
            )",
            
            "displayName": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
            },
            "joinedAt": {
              ".validate": "newData.isNumber()"
            },
            "ready": {
              ".validate": "newData.isBoolean()"
            }
          }
        },
        
        // ゲームプレイデータ
        "gameplay": {
          ".read": "auth != null && data.parent().child('players').hasChild(auth.uid)",
          
          "$playerId": {
            ".read": "auth != null && data.parent().parent().child('players').hasChild(auth.uid)",
            ".write": "auth != null && auth.uid === $playerId",
            
            "score": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "progress": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "lastUpdate": {
              ".validate": "newData.isNumber()"
            }
          }
        }
      }
    },
    
    // マッチメイキングシステム（セキュリティ強化）
    "matchmaking": {
      ".read": "auth != null",
      ".write": false, // 個別ルールのみ許可
      
      "queues": {
        "$queueType": {
          ".read": "auth != null",
          ".write": false,
          
          "$userId": {
            ".read": "auth != null",
            ".write": "auth != null && auth.uid === $userId", // 自分のエントリーのみ
            
            "displayName": {
              ".validate": "newData.isString() && newData.val().length > 0"
            },
            "queuedAt": {
              ".validate": "newData.isNumber()"
            },
            "gamePreferences": {
              ".validate": "newData.isString()"
            }
          }
        }
      }
    },
    
    // オンラインユーザー状態管理
    "online_users": {
      ".read": "auth != null",
      ".write": false,
      
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $userId", // 自分の状態のみ変更可能
        
        "status": {
          ".validate": "newData.isString() && newData.val().matches(/^(online|away|ingame)$/)"
        },
        "lastSeen": {
          ".validate": "newData.isNumber()"
        },
        "currentSession": {
          ".validate": "newData.isString() || newData.val() === null"
        }
      }
    },
    
    // アクティブセッション監視（システム用）
    "active_sessions": {
      ".read": "auth != null",
      ".write": false,
      
      "$sessionId": {
        ".read": "auth != null",
        ".write": "auth != null && (
          root.child('game_sessions').child($sessionId).child('creatorId').val() === auth.uid ||
          root.child('game_sessions').child($sessionId).child('players').hasChild(auth.uid)
        )",
        
        "lastActivity": {
          ".validate": "newData.isNumber()"
        },
        "playerCount": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 4"
        }
      }
    },
    
    // ユーザープロフィール（基本情報のみ）
    "user_profiles": {
      ".read": "auth != null",
      ".write": false,
      
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid === $userId",
        
        "displayName": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
        },
        "avatar": {
          ".validate": "newData.isString() || newData.val() === null"
        },
        "updatedAt": {
          ".validate": "newData.isNumber()"
        }
      }
    }
  }
}
